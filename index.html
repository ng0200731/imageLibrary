<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Library â€” Minimal Shell</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="Main menu">
      <div class="brand">
        <div class="hamburger">
          <div class="hamburger__line"></div>
          <div class="hamburger__line"></div>
          <div class="hamburger__line"></div>
        </div>
        <span>Image Library</span>
      </div>
      <nav class="menu">
        <a id="nav-library" class="menu__item is-active" href="#">Image Library</a>
        <a id="nav-upload" class="menu__item" href="#">Upload Image</a>
        <a id="nav-tags" class="menu__item" href="#">Tags</a>
        <a id="nav-settings" class="menu__item" href="#">Settings</a>
      </nav>

      <div class="version-wrapper">
          <span class="version">v2.1.0</span>
      </div>

      <div class="sidebar__footer">
        <button class="button button--primary" type="button">Login</button>
      </div>
    </aside>

    <main class="content">
      <!-- Image Library Page (Default) -->
      <div id="page-library" class="page">
        <header class="content__header">
          <h1 class="title">Image Library</h1>
          <div class="legend" style="margin-top:8px;">Solid = Objective, Dashed = Subjective</div>
        </header>
        <section class="panel">
          <div class="search-bar">
            <input type="text" id="library-search-input" placeholder="Enter tags separated by commas...">
            <div class="search-options">
              <label><input type="radio" name="search-mode" value="AND" checked> AND (all tags must match)</label>
              <label><input type="radio" name="search-mode" value="OR"> OR (any tag can match)</label>
            </div>
          </div>
          <div id="library-grid" class="preview-grid"></div>
        </section>
      </div>

      <!-- Upload Image Page -->
      <div id="page-upload" class="page is-hidden">
          <header class="content__header">
            <h1 class="title">Upload Images</h1>
          </header>
          <section class="panel">
            <div id="dropzone" class="upload-area">
              <div class="preview-header">
                <h2 class="panel__title">Selected Images</h2>
                <div class="upload-actions">
                  <input type="file" id="file-input" class="file-input" multiple />
                  <label for="file-input" class="button">Browse Files</label>
                  <button id="clear-all" class="button" type="button">Clear All</button>
                </div>
              </div>
              <p class="text">Browse, drag & drop, or paste images</p>
              <div id="preview-grid" class="preview-grid"></div>
            </div>
            <div class="upload-actions">
                <button id="upload-button" class="button button--primary" type="button">Upload</button>
            </div>
          </section>

          <!-- Layer 3: Tag panels -->
          <section class="panel">
            <div class="apply-scope">
              Apply to: <button id="apply-all" class="button" type="button">All images</button>
              <button id="apply-selected" class="button" type="button">Selected only</button>
              <span class="legend">Solid = Objective, Dashed = Subjective</span>
            </div>

            <div class="tag-panels">
              <div class="tag-panel tag-panel--objective">
                <div class="tag-panel__header is-objective">OBJECTIVE (FACTS)</div>
                <div class="tag-panel__body">
                  <label class="tag-input">
                    brand: <input id="obj-brand" type="text" placeholder="brand:nike" />
                  </label>
                  <label class="tag-input">
                    color: <input id="obj-color" type="text" placeholder="color:red" />
                  </label>
                  <div id="obj-chips" class="chips"></div>
                </div>
              </div>

              <div class="tag-panel tag-panel--subjective">
                <div class="tag-panel__header is-subjective">SUBJECTIVE (FEELINGS)</div>
                <div class="tag-panel__body">
                  <div class="subj-inline">
                    <div>
                      <label class="tag-input">Add feelings:
                        <input id="subj-input" type="text" placeholder="type and press Enter/Tab" />
                      </label>
                      <div class="hint">Press Enter or Tab to add; Backspace removes last when empty</div>
                    </div>
                    <div id="subj-chips" class="chips"></div>
                  </div>
                </div>
              </div>
            </div>
          </section>
      </div>
    </main>
  </div>

      .modal-content-text {
        margin: auto;
        padding: 20px;
        background-color: #fff;
        width: fit-content;
        border-radius: 5px;
      }



  <!-- Lightbox Modal -->
  <div id="lightbox-modal" class="modal is-hidden">
    <span class="modal-close">&times;</span>
    <a class="prev">&#10094;</a>
    <img class="modal-content" id="lightbox-image">
    <a class="next">&#10095;</a>
  </div>


      <!-- Loading Overlay -->
      <div id="loading-overlay" class="modal is-hidden">
        <div class="modal-content-text">
          Uploading... Please wait.
        </div>
      </div>

  <script>
    // --- Constants & State ---
    const API_URL = 'http://localhost:3000';
    const navLinks = {
        library: document.getElementById('nav-library'),
        upload: document.getElementById('nav-upload'),
    };
    const pages = {
        library: document.getElementById('page-library'),
        upload: document.getElementById('page-upload'),
    };
    const fileInput = document.getElementById('file-input');
    const previewGrid = document.getElementById('preview-grid');
    const clearAllButton = document.getElementById('clear-all');
    const dropzone = document.getElementById('dropzone');
    const subjInput = document.getElementById('subj-input');
    const subjChips = document.getElementById('subj-chips');
    const modal = document.getElementById('lightbox-modal');
    const modalImg = document.getElementById('lightbox-image');
    const closeModal = document.querySelector('.modal-close');
    const prevButton = document.querySelector('.prev');
    const nextButton = document.querySelector('.next');
    const uploadButton = document.getElementById('upload-button');
    const librarySearchInput = document.getElementById('library-search-input');
    const libraryGrid = document.getElementById('library-grid');
    const searchModeRadios = document.querySelectorAll('input[name="search-mode"]');

    let filesToUpload = [];
    let currentImageIndex = 0;
    let imageSources = [];

    // --- Function Definitions ---

    async function displayLibraryImages() {
        const searchTerm = librarySearchInput.value;
        const searchMode = document.querySelector('input[name="search-mode"]:checked').value;
        const searchTags = searchTerm.split(',').map(tag => tag.trim()).filter(tag => tag);

        try {
            const response = await fetch(`${API_URL}/images?tags=${searchTags.join(',')}&mode=${searchMode}`);
            const images = await response.json();

            libraryGrid.innerHTML = '';
            images.forEach(image => {
                const card = document.createElement('div');
                card.className = 'preview-card';
                const img = document.createElement('img');
                img.src = `${API_URL}/${image.filepath.replace(/\\/g, '/')}`;
                card.appendChild(img);
                libraryGrid.appendChild(card);
            });
        } catch (error) {
            console.error('Error fetching images:', error);
        }
    }

    function navigateTo(pageName) {
        Object.values(pages).forEach(page => page.classList.add('is-hidden'));
        document.querySelectorAll('.menu__item').forEach(link => link.classList.remove('is-active'));
        pages[pageName].classList.remove('is-hidden');
        navLinks[pageName].classList.add('is-active');

        if (pageName === 'library') {
            displayLibraryImages();
        }
    }

    function handleFiles(files) {
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            filesToUpload.push(file);

            const reader = new FileReader();
            reader.onload = (e) => {
                const card = document.createElement('div');
                card.className = 'preview-card';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.addEventListener('click', (event) => {
                    const allImages = Array.from(previewGrid.querySelectorAll('img'));
                    const clickedIndex = allImages.indexOf(event.target);
                    openModal(clickedIndex);
                });

                const del = document.createElement('button');
                del.type = 'button';
                del.className = 'delete-btn';
                del.textContent = 'x';
                del.addEventListener('click', () => {
                    const indexToRemove = filesToUpload.indexOf(file);
                    if (indexToRemove > -1) {
                        filesToUpload.splice(indexToRemove, 1);
                    }
                    card.remove();
                });

                card.appendChild(del);
                card.appendChild(img);
                previewGrid.appendChild(card);
            };
            reader.readAsDataURL(file);
        }
    }

    function addSubjChip(label) {
        const text = (label || '').toLowerCase().trim();
        if (!text) return;
        if ([...subjChips.querySelectorAll('.chip')].some(c => c.textContent.replace(/x$/, '').trim() === text)) return;
        const chip = document.createElement('span');
        chip.className = 'chip is-subjective';
        chip.textContent = text;
        chip.tabIndex = 0;
        chip.addEventListener('click', () => chip.classList.toggle('is-selected'));
        const x = document.createElement('button');
        x.type = 'button';
        x.className = 'x';
        x.textContent = 'x';
        x.addEventListener('click', (ev) => { ev.stopPropagation(); chip.remove(); });
        chip.appendChild(x);
        subjChips.appendChild(chip);
    }

    function handleSubjCommit() {
        const parts = subjInput.value.split(',');
        parts.forEach(p => addSubjChip(p));
        subjInput.value = '';
    }

    function updateArrowVisibility() {
        const totalImages = imageSources.length;
        prevButton.style.display = (currentImageIndex > 0 && totalImages > 1) ? 'block' : 'none';
        nextButton.style.display = (currentImageIndex < totalImages - 1 && totalImages > 1) ? 'block' : 'none';
    }

    function openModal(index) {
        currentImageIndex = index;
        imageSources = Array.from(previewGrid.querySelectorAll('img')).map(img => img.src);
        modalImg.src = imageSources[currentImageIndex];
        modal.classList.remove('is-hidden');
        updateArrowVisibility();
    }

    function showImage(index) {
        if (index >= imageSources.length || index < 0) return;
        currentImageIndex = index;
        modalImg.src = imageSources[currentImageIndex];
        updateArrowVisibility();
    }

    function hideModal() {
        modal.classList.add('is-hidden');
    }

    // --- Event Listeners ---

    navLinks.library.addEventListener('click', (e) => { e.preventDefault(); navigateTo('library'); });
    navLinks.upload.addEventListener('click', (e) => { e.preventDefault(); navigateTo('upload'); });

    fileInput.addEventListener('change', (event) => {
        handleFiles(event.target.files);
    });

    clearAllButton.addEventListener('click', () => {
        previewGrid.innerHTML = '';
        filesToUpload = [];
        fileInput.value = '';
    });

    subjInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === 'Tab' || e.key === ',') {
            e.preventDefault();
            handleSubjCommit();
        } else if (e.key === 'Backspace' && subjInput.value === '') {
            const chips = subjChips.querySelectorAll('.chip');
            const last = chips[chips.length - 1];
            if (last) subjChips.removeChild(last);
        }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => dropzone.classList.add('is-dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => dropzone.classList.remove('is-dragover'), false);
    });
    dropzone.addEventListener('drop', (e) => {
        handleFiles(e.dataTransfer.files);
    }, false);

    window.addEventListener('paste', (e) => {
        if (pages.upload.classList.contains('is-hidden')) return;
        handleFiles(e.clipboardData.files);
        dropzone.classList.add('is-dragover');
        setTimeout(() => dropzone.classList.remove('is-dragover'), 150);
    });

    prevButton.addEventListener('click', () => showImage(currentImageIndex - 1));
    nextButton.addEventListener('click', () => showImage(currentImageIndex + 1));
    closeModal.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal();
        }
    });

    const loadingOverlay = document.getElementById('loading-overlay');

    uploadButton.addEventListener('click', async () => {
        const tags = Array.from(subjChips.querySelectorAll('.chip')).map(chip => chip.textContent.replace(/x$/, '').trim());
        if (filesToUpload.length === 0) {
            return alert('Please select images to upload.');
        }

        const formData = new FormData();
        filesToUpload.forEach(file => {
            formData.append('images', file);
        });
        formData.append('tags', JSON.stringify(tags));

        // Show loading state
        uploadButton.disabled = true;
        loadingOverlay.classList.remove('is-hidden');

        try {
            const response = await fetch(`${API_URL}/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Upload failed: ${errorText}`);
            }

            alert('Images uploaded successfully!');
            // Clear UI on success
            previewGrid.innerHTML = '';
            subjChips.innerHTML = '';
            filesToUpload = [];
            fileInput.value = '';
        } catch (error) {
            console.error('Error uploading images:', error);
            alert(`An error occurred during upload. Please try again. Details: ${error.message}`);
            // On failure, do not clear the UI so the user can retry
        } finally {
            // Hide loading state
            uploadButton.disabled = false;
            loadingOverlay.classList.add('is-hidden');
        }
    });

    librarySearchInput.addEventListener('input', displayLibraryImages);
    searchModeRadios.forEach(radio => radio.addEventListener('change', displayLibraryImages));


  </script>
</body>
</html>

